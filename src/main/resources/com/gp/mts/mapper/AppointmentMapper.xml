<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gp.mts.mapper.AppointmentMapper">
    <!-- 检查重复预约 -->
    <select id="countByPrisonerIdAndVisitorIdAndDate" resultType="int">
        SELECT COUNT(*)
        FROM appointments
        WHERE prisoner_id = #{prisonerId}
          AND visitor_id = #{visitorId}
          AND appointment_date = #{date}
    </select>

    <!-- 新增预约 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO appointments (
            prisoner_id, prisoner_name, visitor_name, visitor_id,
            relation, phone, appointment_date, appointment_time,
            status, create_time
        ) VALUES (
                     #{prisonerId}, #{prisonerName}, #{visitorName}, #{visitorId},
                     #{relation}, #{phone}, #{appointmentDate}, #{appointmentTime},
                     #{status}, NOW()
                 )
    </insert>

    <!-- 多条件查询 -->
    <select id="selectByVisitorIdAndPrisonerId" resultType="com.gp.mts.bean.po.Appointment">
        SELECT * FROM appointments
        WHERE visitor_id = #{visitorId}
          AND prisoner_id = #{prisonerId}
        ORDER BY appointment_date DESC
    </select>

    <!-- 按会见人ID查询 -->
    <select id="selectByVisitorId" resultType="com.gp.mts.bean.po.Appointment">
        SELECT * FROM appointments
        WHERE visitor_id = #{visitorId}
        ORDER BY appointment_date DESC
    </select>

    <!-- 按服刑人员ID查询 -->
    <select id="selectByPrisonerId" resultType="com.gp.mts.bean.po.Appointment">
        SELECT * FROM appointments
        WHERE prisoner_id = #{prisonerId}
        ORDER BY appointment_date DESC
    </select>

    <!-- 查询所有 -->
    <select id="selectAllOrderByDateDesc" resultType="com.gp.mts.bean.po.Appointment">
        SELECT * FROM appointments
        ORDER BY appointment_date DESC
    </select>

    <!-- 按状态查询 -->
    <select id="selectByStatusOrderByDateDesc" resultType="com.gp.mts.bean.po.Appointment">
        SELECT * FROM appointments
        WHERE status = #{status}
        ORDER BY appointment_date DESC
    </select>

    <!-- 按ID查询 -->
    <select id="selectById" resultType="com.gp.mts.bean.po.Appointment">
        SELECT * FROM appointments WHERE id = #{id}
    </select>

    <!-- 更新状态 -->
    <update id="updateStatus">
        UPDATE appointments
        SET status = #{status}
        WHERE id = #{id}
    </update>
</mapper>
